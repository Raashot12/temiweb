name: 'Successful Deploy Notification'
description: 'Send successful deploy notification via Slack'

inputs:
  actor:
    description: 'Actor'
    default: ${{ github.actor }}
  branch:
    description: 'Branch name'
    default: ${{ github.head_ref || github.ref_name }}
  repo:
    description: 'repository name'
    default: ${{ github.event.repository.name }}
  slack:
    description: 'slack webhook'
    default: ${{ github.event.repository.name }}

runs:
  using: 'composite'
  steps:
    - name: Get Daily Commits
      shell: bash
      run: |
        echo 'DAILY_COMMITS<<EOF' >> $GITHUB_ENV
        git log --format=format:"The author of %h was %an, %ar%n \nThe title was: %s %n" --since=1.days >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
    - name: Send Slack Notification
      id: send-notification
      shell: bash
      run: |
        BRANCH=$(echo ${{ inputs.branch }})
        
        color=" "
        if [[ $BRANCH == "develop" ]];
        then
          color=$(echo "#34d2eb")
        elif [[ $BRANCH == "staging" ]];
        then
          color=$(echo "#3437eb")
        elif [[ $BRANCH == "prod" || $BRANCH == "main" ]];
        then
         color=$(echo "#00cf29")
        fi
          curl -X POST -H 'Content-type: application/json'  ${{ inputs.slack }} --data-binary @- << EOF
                  {
                      "mrkdwn_in": ["text"],
                      "color": "#36a64f",
                      "title": "Backend deployment success :large_green_circle:",
                      "author_name": "${{ inputs.actor }}",
                      "text": "Backend can be deployed to staging",
                      "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "fields":
                      [
                          {
                              "title": "Branch",
                              "value": "${{ inputs.branch }}",
                              "short": true
                          },
                          {
                              "title": "Author",
                              "value": "${{ inputs.actor }}",
                              "short": true
                          },
                          {
                             "title": "Commits for today",
                             "value": "${{ env.DAILY_COMMITS }}",
                             "short": false
                          },
                          {
                              "title": "Tags",
                              "value": "<@U058EFFQCH0|cal> <@U01P6GX8W6B|cal> <@U02E65CKG8N|cal> <@U05FTK907U7|cal>",
                              "short": false
                          }
                      ],
                      "thumb_url": "https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png",
                      "ts": 123456789
                  }
              ]
          }
         EOF
